language: C
dist: xenial

stages:
  - Base
  - Lint
  - Test

matrix:
  include:
    - name: verifying travis.yml file
      stage: Base
      script:
        - python3 .travis_gen.py > expected.out
        - diff .travis.yml expected.out
    - name: test project compile
      stage: Base
      install:
        - travis_retry curl -L https://www.libsdl.org/release/SDL2-2.0.9.tar.gz | tar xz; cd SDL2-2.0.9; ./configure; make; sudo make install; cd ..; rm -rf SDL2-2.0.9
      script:
        - make
    - name: all C files in Makefile
      stage: Base
      script:
        - diff <(make print-SRC | tr ' ' '\n' | sort) <(find src -name "*.c" | sort)
    - name: all headers files in Makefile
      stage: Base
      script:
        - diff <(make print-INC | tr ' ' '\n' | sort) <(find inc -name "*.h" | sort)
    - name: uncrustify
      stage: Lint
      script:
        - make uncrustify_check
    - name: cpplint
      stage: Lint
      before_install: sudo apt-get update
      install:
        - sudo apt-get install -y --no-install-recommends python3-venv
      script:
        - make cpplint_run
    - name: cppcheck
      stage: Lint
      before_install: sudo apt-get update
      install:
        - sudo apt-get install -y --no-install-recommends cppcheck
      script:
        - make cppcheck_run
    - name: clang-tidy
      stage: Lint
      before_install: sudo apt-get update
      install:
        - sudo apt-get install -y --no-install-recommends clang-tidy-6.0 clang-6.0
        - travis_retry curl -L https://www.libsdl.org/release/SDL2-2.0.9.tar.gz | tar xz; cd SDL2-2.0.9; ./configure; make; sudo make install; cd ..; rm -rf SDL2-2.0.9
      script:
        - make clang_tidy_run
    - name: infer
      stage: Lint
      install:
        - travis_retry curl -L https://www.libsdl.org/release/SDL2-2.0.9.tar.gz | tar xz; cd SDL2-2.0.9; ./configure; make; sudo make install; cd ..; rm -rf SDL2-2.0.9
      script:
        - sudo make /usr/local/bin/infer
        - make infer_run
    - name: libcheck
      stage: Test
      before_install: sudo apt-get update
      install:
        - sudo apt-get install -y --no-install-recommends python3-venv check
        - travis_retry curl -L https://www.libsdl.org/release/SDL2-2.0.9.tar.gz | tar xz; cd SDL2-2.0.9; ./configure; make; sudo make install; cd ..; rm -rf SDL2-2.0.9
      script:
        - make cimp_check
